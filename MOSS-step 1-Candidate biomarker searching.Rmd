#This code will rank all the compounds with 1000 permutations and output a candidate list of biomarkers regarding certain question, which is output 1 in Figure 1.
#Figure 2A, 2B, 2C, 3B, 4B are generated by this code.

```{r}
library(dplyr)
library(tidyverse)
```

Ranking variable by AUC value
```{r}
roc.rank<-function(train){
library(pROC)
auc.rank=data.frame()
for (i in 2:ncol(train)){
roc.model<- quietroc(train$group, train[,i])
auc.rank[i-1,1]=colnames(train)[i]
auc.rank[i-1,2]=as.numeric(roc.model[["result"]][["auc"]])
colnames(auc.rank)=c("features","auc")
}##注意control 和 case区分
return(auc.rank)
}
```

Ranking variable by VIP of top 1 components in PLSDA
```{r}
plsda.rank<-function(train){
library(mixOmics)
plsda.model<-plsda(train[1:nrow(train),2:ncol(train)],train[1:nrow(train),1],ncomp=2)
vip.12=as.data.frame(vip(pls(train[1:nrow(train),2:ncol(train)],as.numeric(train[1:nrow(train),1]))))
vip.rank=data.frame()
vip.rank[1:ncol(train),1]=colnames(train)
vip.rank[2:ncol(train),2]=sqrt((vip.12[,1])^2+(vip.12[,2])^2)
vip.rank=vip.rank[-1,]
colnames(vip.rank)=c("features","vip")
#plotIndiv(plsda.model, ind.names = FALSE, legend = TRUE, ellipse = TRUE,title = 'PLS-DA')
return(vip.rank)
}
```


Ranking variable by p-value
```{r}
ttest.rank<-function(train){
group.train=unique(train[,1])
train1=train[train$group==group.train[1],]
train2=train[train$group==group.train[2],]

pvalue.rank=data.frame()
for (i in 2:ncol(train)){
  pvalue.rank[i-1,1]=colnames(train)[i]
  pvalue=t.test(train1[,i],train2[,i])
  pvalue.rank[i-1,2]=pvalue$p.value
}
colnames(pvalue.rank)=c("features","pvalue")
return(pvalue.rank)
}
```

Ranking variable by random forest gini index
```{r}
rf.rank<-function(train){
library(randomForest)
# #选取randomforest –mtry节点值，对应误差最小为2，一般可默认
# for (i in 3:ncol(train)){
#   mtry_fit<-randomForest(group~.,data=train,mtry=2)
#   err<-mean(mtry_fit$err.rate)
#   print(err)
# }
# #选择ntree值，ntree指定随机森林所包含的决策树数目，默认为500, 看图稳定在多少
# #https://www.cnblogs.com/nxld/p/6374945.html
rf.model<-randomForest(group~.,data=train,mtry=2,ntree=3000)
# plot(rf.model)
gini.rank=importance(rf.model)#calculate gini index
gini.rank<-rownames_to_column(as.data.frame(gini.rank), var = "features") 
#Gini.plot=varImpPlot(rf.model)#draw gini index ranking plot 
colnames(gini.rank)=c("features","gini")
return(gini.rank)
}
```

Ranking variable by liner SVM
```{r}
svm.rank<-function(train){
#library(e1071)
#svm.model1<-svm(group~.,data=train,kernel = "linear")
#https://rpubs.com/uky994/593668
library(caret)
library(kernlab)
svm.model<-train(group~.,data=train,method="svmLinear",preProcess=c("center","scale"))
svmimp.rank<-varImp(object=svm.model)$importance
svmimp.rank<-rownames_to_column(svmimp.rank, var = "features") 
svmimp.rank<-svmimp.rank[,-3]
colnames(svmimp.rank)=c("features","svmimp")
return(svmimp.rank)
}
```

predict test group using plsda model
```{r}
plsda.class<-function(topn,train,test,class_method){
if (class_method=="plsda"){
library(mixOmics)
model.topn<-plsda(train[topn$features],train[1:nrow(train),1],ncomp=2)
predict.model<-predict(model.topn,newdata=as.matrix(test[topn$features]))
prob.num1<-as.numeric(sqrt(predict.model$predict[,1,1]^2+predict.model$predict[,1,2]^2))
prob.num2<-as.numeric(sqrt(predict.model$predict[,2,1]^2+predict.model$predict[,2,2]^2))
prob.bin<-matrix(0,length(prob.num1),1)
prob.bin[prob.num1<prob.num2,]=1


}else if (class_method=="rf") {
library(randomForest)
data_=cbind(train$group,train[topn$features])
colnames(data_)[1]="group"
model.topn<-randomForest(group~.,data=data_,mtry=2,ntree=3000)
predict.model<-predict(model.topn,newdata=test[topn$features],type = "prob", prob = TRUE)
prob.bin=as.numeric(predict.model)
}

  if (sum(prob.bin)==0){
    im.total=0
  }else{
roc.model<-quietroc(test[,1],prob.bin)
im.total=as.numeric(roc.model[["result"]][["auc"]])
  }

return(im.total)
}
```

use rank to select variable
```{r}
library(progress)    
rank.cv<-function(data,rank_method,class_method,iteration_number,topn_number){
pb <- progress_bar$new(format = "(:spin) [:bar] :percent [Elapsed time: :elapsedfull || Estimated time remaining: :eta]",
                       total = iteration_number,
                       complete = "=",   # Completion bar character
                       incomplete = "-", # Incomplete bar character
                       current = ">",    # Current bar character
                       clear = FALSE,    # If TRUE, clears the bar when finish
                       width = 100)      # Width of the progress bar
auc.list=data.frame()
rank.list=list()
iteration=1
while(iteration < iteration_number+1){
group=unique(data[,2])
data1=data[data$group==group[1],]
data2=data[data$group==group[2],]
#set.seed(100)
run=0
while (run==0){
  ind1<-sample(2,nrow(data1),replace=TRUE,prob=c(0.7,0.3))
  if (sum(ind1)==length(ind1)){
    run=0
  }else{
    run=1
  }
}
ind2<-sample(2,nrow(data2),replace=TRUE,prob=c(0.7,0.3))

train<-rbind(data1[ind1==1,],data2[ind2==1,])
train=train[,-1]

test<-rbind(data1[ind1==2,],data2[ind2==2,])
test=test[,-1]
#print("part 1 okay")
if (rank_method=="ttest"){
  rank=ttest.rank(train)
  rank<-arrange(rank,rank$pvalue)
  }else if (rank_method=="roc"){
  rank=roc.rank(train)
  rank<-arrange(rank,desc(rank$auc))
  }else if (rank_method=="plsda"){
  rank=plsda.rank(train)
  rank<-arrange(rank,desc(rank$vip)) 
  }else if (rank_method=="rf"){
  rank=rf.rank(train)
  rank<-arrange(rank,desc(rank$gini)) 
  #print("part 2 okay")
  }else if (rank_method=="svm"){
  rank=svm.rank(train)
  rank<-arrange(rank,desc(rank$svmimp))
  }

rank.list[[iteration]]=rank
auc.increase=data.frame()
for (i in 2:topn_number){
  #print(paste("part 3 okay",i))
  topn<-rank[1:i,1:ncol(rank)]
  auc.increase[i,1]=plsda.class(topn,train,test,class_method)
  #print(paste("Running on top",i,"feature(s)"))
}
auc.list[1:topn_number,iteration]=auc.increase
print(paste("Ranking method",rank_method,"Class method",class_method,iteration,"iteration(s)"))

iteration=iteration+1
pb$tick()
}

auc.list=list(auc.list=auc.list)
result=c(auc.list,rank.list)
}
```



```{r}
data.path="~/OneDrive - The Ohio State University/Rui Xu-Research/Bourbon study II 2021S-/Data Archive"
data.folder="/LC pos Features CV0.3 SN3 INT10000 proof/"
data.file="LC pos Features CV0.3 SN3 INT10000 proof for cut-off"
data= read.csv(paste(data.path,"/",data.folder,"/",data.file,".csv",sep=""))
colnames(data)[2]=c("group")
#only for proof
#########################
proof=unique(sort(data[,2]))
data1=data
for (i in 1:length(proof)){
data=data1
data$group[data$group<=proof[i]]=0
data$group[data$group>proof[i]]=1
proof.performance=data.frame()
#########################
data$group=as.factor(data$group)
library(pROC)
quietroc=quietly(roc)
setwd(paste(data.path,"/",data.folder,sep=""))
result=rank.cv(data,"plsda","plsda",1,ncol(data)-2)
proof.performance[i,1]=max(result[[1]],na.rm=TRUE)
save(result,file="ranking method plsda class method plsda 10 iterations with 1408 compounds.rda")
result=rank.cv(data,"ttest","plsda",1,ncol(data)-2)
proof.performance[i,2]=max(result[[1]],na.rm=TRUE)
save(result,file="ranking method ttest class method plsda 10 iterations with 1408 compounds.rda")
result=rank.cv(data,"roc","plsda",1,ncol(data)-2)
proof.performance[i,3]=max(result[[1]],na.rm=TRUE)
save(result,file="ranking method roc class method plsda 10 iterations with 1408 compounds.rda")
result=rank.cv(data,"rf","plsda",1,ncol(data)-2)
proof.performance[i,4]=max(result[[1]],na.rm=TRUE)
save(result,file="ranking method rf class method plsda 10 iterations with 1408 compounds.rda")
result=rank.cv(data,"svm","plsda",1,ncol(data)-2)
proof.performance[i,5]=max(result[[1]],na.rm=TRUE)
save(result,file="ranking method svm class method plsda 10 iterations with 1408 compounds.rda")
print(paste("when proof is",proof[i],",the auc are",proof.performance[i,],sep=" "))
}
```


```{r}
data.path="~/OneDrive - The Ohio State University/Rui Xu-Research/Bourbon study II 2021S-/Data Archive"
data.file="LC pos Features CV0.3 SN3 INT10000 proof"
permutation=1000
setwd(paste(data.path,"/",data.file,sep=""))
file.name="all-plsda-1000-1408"
load(paste(data.path,"/",data.file,"/ranking method svm class method plsda ",permutation," iterations with 1408 compounds proof.rda",sep=""))
auc.svm=result$auc.list
ave.svm=as.data.frame(rowMeans(auc.svm,2))
ave.svm=ave.svm[-1,]
load(paste(data.path,"/",data.file,"/ranking method rf class method plsda ",permutation," iterations with 1408 compounds proof.rda",sep=""))
auc.rf=result$auc.list
ave.rf=as.data.frame(rowMeans(auc.rf,2))
ave.rf=ave.rf[-1,]
load(paste(data.path,"/",data.file,"/ranking method plsda class method plsda ",permutation," iterations with 1408 compounds proof.rda",sep=""))
auc.plsda=result$auc.list
ave.plsda=as.data.frame(rowMeans(auc.plsda,2))
ave.plsda=ave.plsda[-1,]
load(paste(data.path,"/",data.file,"/ranking method roc class method plsda ",permutation," iterations with 1408 compounds proof.rda",sep=""))
auc.roc=result$auc.list
ave.roc=as.data.frame(rowMeans(auc.roc,2))
ave.roc=ave.roc[-1,]
load(paste(data.path,"/",data.file,"/ranking method ttest class method plsda ",permutation," iterations with 1408 compounds proof.rda",sep=""))
auc.ttest=result$auc.list
ave.ttest=as.data.frame(rowMeans(auc.ttest,2))
ave.ttest=ave.ttest[-1,]


# ave.rf=ave.plsda
# ave.roc=ave.plsda
#ave.ttest=ave.plsda
#   ave.ttest=matrix(0,1405,1)
#   colnames(ave.ttest)=c("ave.ttest")
#   ave.svm=matrix(0,1405,1)
#   colnames(ave.svm)=c("ave.svm")
ave=as.data.frame(cbind(1:1405,ave.plsda,ave.rf,ave.roc,ave.svm,ave.ttest))

# lines(x=c(which.max(ave),which.max(ave)), y=c(0.5,max(ave)), type = "l", lty = "dashed",col="red",lwd=2)
# lines(x=c(-50,which.max(ave)), y=c(max(ave),max(ave)), type = "l", lty = "dashed",col="red",lwd=2)
# text(x=c(which.max(ave)-50,20), y=c(0.99*min(ave)+0.01*max(ave),0.95*max(ave)+0.05*min(ave)),labels=c(which.max(ave),round(max(ave),3)),col="red",cex=1)
```

```{r}
library(tidyr)
ave.longer<- ave%>% 
  pivot_longer(cols=c("ave.ttest","ave.roc","ave.plsda","ave.rf","ave.svm"),names_to ="group",values_to="ave")
library(ggplot2)
P=ggplot(ave.longer, aes(x=V1,y=ave,col=group)) +
  geom_line()+
  # geom_segment(aes(x = 1-draw.performance[4,1], y = draw.performance[4,2], xend = 1-draw.performance[5,1], yend = draw.performance[5,2]))+
  # geom_segment(aes(x = 1-draw.performance[6,1], y = draw.performance[6,2], xend = 1-draw.performance[5,1], yend = draw.performance[5,2]))+
  # geom_segment(aes(x = 1-draw.performance[3,1], y = draw.performance[3,2], xend = 1-draw.performance[2,1], yend = draw.performance[2,2]),color="lightblue")+
  scale_color_discrete(name = "Group",
                       labels = c("PLSDA",
                                  "RF",
                                  "ROC",
                                  "SVM",
                                  "TTEST")) +
  labs(y = "Area Under Curve(AUC)",x="Feature #") +
    theme(plot.title = element_text(color="black",size=15),
          axis.title.x=element_text(size=15),
          axis.title.y=element_text(size=15),
          panel.background = element_rect(fill = "white", colour="grey50"),
          axis.text=element_text(size=12),
          legend.title = element_text(colour="black", size=12),
          legend.text = element_text(colour="black", size=12),
          legend.position="top")

```


```{r}
library(ggplot2)
ggsave(paste(data.path,"/",data.file,"/all-plsda-1000-1048.png",sep=""), plot = P,width = 11,height = 4)
```









